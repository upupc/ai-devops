# 提案：构建多轮对话 Agent 应用

## 概述

构建一个基于 Claude Agent SDK 的 AI Agent Web 应用，支持多轮对话，具有三栏式布局：聊天框、工作区和文件浏览器。

## 背景

用户需要一个能够与 AI Agent 进行交互的 Web 应用，Agent 不仅能够回答问题，还能操作文件系统、执行命令，并将结果展示在专属的工作区中。

## 目标

1. 提供直观的聊天界面进行多轮对话
2. 为每个会话创建独立的工作区目录
3. 支持文件的在线查看和编辑
4. 集成 Claude Agent SDK 实现智能 Agent 功能

## 需求追踪

> **注意**：本提案缺少 Aone 需求链接，基于 PRD 文档直接创建。

## 技术栈

| 类型 | 技术选型 |
|------|----------|
| 前端框架 | Next.js (App Router) |
| UI 组件库 | Ant Design |
| AI SDK | @anthropic-ai/claude-agent-sdk (v2 preview) |
| 代码编辑器 | Monaco Editor |
| 架构 | 前后端一体化 |

## 核心能力

### 1. 聊天系统 (chat)

- 多轮对话支持
- 会话管理（创建、切换、删除）
- 消息历史展示
- 流式响应显示

### 2. 工作区系统 (workspace)

- 每个会话对应独立工作区目录
- 代码编辑器（支持语法高亮）
- 文件内容预览
- 支持文件类型：代码文件、Markdown、配置文件

### 3. 文件浏览器 (file-browser)

- 树形结构展示工作区文件
- 文件/文件夹操作（创建、删除、重命名）
- 文件选择与编辑器联动

### 4. Agent 工具能力

- **read_file**: 读取工作区中的文件内容
- **write_file**: 创建或修改文件
- **execute_command**: 在工作区中执行终端命令

## 系统架构

```
┌──────────────────────────────────────────────────────────────────┐
│                         Next.js 应用                              │
├──────────────────────────────────────────────────────────────────┤
│  前端 (React + Ant Design)                                        │
│  ┌─────────────┬─────────────────────┬─────────────────┐         │
│  │   聊天框     │      工作区         │    文件浏览器    │         │
│  │  (Chat)     │    (Workspace)      │  (FileBrowser)  │         │
│  │             │                     │                 │         │
│  │  - 消息列表  │  - Monaco 编辑器    │  - 文件树        │         │
│  │  - 输入框   │  - 文件预览         │  - 目录导航      │         │
│  │  - 会话管理  │  - 标签页管理       │  - 文件操作      │         │
│  └─────────────┴─────────────────────┴─────────────────┘         │
├──────────────────────────────────────────────────────────────────┤
│  后端 (Next.js API Routes)                                        │
│  ┌─────────────┬─────────────────────┬─────────────────┐         │
│  │  /api/chat  │  /api/workspace     │  /api/files     │         │
│  │             │                     │                 │         │
│  │  - 发送消息  │  - 创建工作区       │  - 列出文件      │         │
│  │  - 会话管理  │  - 获取工作区信息    │  - 读取文件      │         │
│  │             │                     │  - 写入文件      │         │
│  └─────────────┴─────────────────────┴─────────────────┘         │
├──────────────────────────────────────────────────────────────────┤
│  Claude Agent SDK                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │  会话管理 (Session)                                          │ │
│  │  - unstable_v2_createSession / unstable_v2_resumeSession    │ │
│  │  工具定义 (Tools)                                            │ │
│  │  - read_file, write_file, execute_command                   │ │
│  └─────────────────────────────────────────────────────────────┘ │
├──────────────────────────────────────────────────────────────────┤
│  文件系统                                                         │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │  workspaces/                                                 │ │
│  │  ├── session_abc123/                                        │ │
│  │  │   ├── file1.ts                                           │ │
│  │  │   └── config.json                                        │ │
│  │  └── session_def456/                                        │ │
│  │      └── README.md                                          │ │
│  └─────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────┘
```

## 目录结构

```
ai-devops/
├── app/                          # Next.js App Router
│   ├── api/                      # API 路由
│   │   ├── chat/
│   │   │   └── route.ts          # 聊天 API
│   │   ├── workspace/
│   │   │   └── route.ts          # 工作区 API
│   │   └── files/
│   │       └── route.ts          # 文件操作 API
│   ├── components/               # React 组件
│   │   ├── ChatPanel/            # 聊天面板
│   │   ├── WorkspacePanel/       # 工作区面板
│   │   └── FileBrowserPanel/     # 文件浏览面板
│   ├── layout.tsx                # 根布局
│   └── page.tsx                  # 首页
├── lib/                          # 工具库
│   ├── agent/                    # Agent 相关
│   │   ├── session.ts            # 会话管理
│   │   └── tools.ts              # 工具定义
│   └── workspace/                # 工作区管理
│       └── manager.ts
├── workspaces/                   # 工作区文件存储
├── .env.local                    # 环境变量
├── package.json
└── tsconfig.json
```

## 风险与缓解措施

| 风险 | 缓解措施 |
|------|----------|
| Claude Agent SDK v2 是预览版，API 可能变更 | 封装 SDK 调用层，便于后续适配 |
| 文件操作的安全性 | 限制工作区目录范围，禁止访问系统敏感路径 |
| 命令执行的安全性 | 白名单机制，限制可执行的命令类型 |
| 会话状态管理 | 使用持久化存储保存会话信息 |

## 待决问题

1. 会话数据是否需要持久化到数据库？
2. 是否需要用户认证系统？
3. 工作区文件的清理策略是什么？

## 参考资料

- [Claude Agent SDK TypeScript v2 Preview](https://platform.claude.com/docs/en/agent-sdk/typescript-v2-preview)
- [Next.js App Router 文档](https://nextjs.org/docs/app)
- [Ant Design 组件库](https://ant.design/)
- [Monaco Editor](https://microsoft.github.io/monaco-editor/)
